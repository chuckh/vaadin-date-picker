<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../web-component-tester/browser.js"></script>
  <script src="common.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../vaadin-date-picker.html">
</head>

<body>

  <test-fixture id="datepicker">
    <template>
      <vaadin-date-picker></vaadin-date-picker>
    </template>
  </test-fixture>

  <script>
    if (!android && !ios) {
      // The test environment can currently only handle a certain number of tests
      // on the Android emulator. Omitting the keyboard inputs tests on Android for now.
      // Keybard input is disabled on IOS since it doesn't handle fixed positioned elements
      // (the dropdown) well while input is focused.

      describe('keyboard input', function() {

        var target;
        var overlay;
        var datepicker;

        function inputChar(char) {
          target.bindValue += char;
          MockInteractions.keyDownOn(target, char.charCodeAt(0));
          target.fire('input');
        }

        function inputText(text) {
          for (var i = 0; i < text.length; i++) {
            inputChar(text[i]);
          }
        }

        function arrowDown() {
          MockInteractions.keyDownOn(target, 40);
        }

        function arrowRight() {
          MockInteractions.keyDownOn(target, 39);
        }

        function arrowUp() {
          MockInteractions.keyDownOn(target, 38);
        }

        function arrowLeft() {
          MockInteractions.keyDownOn(target, 37);
        }

        function enter() {
          MockInteractions.pressEnter(target);
        }

        function esc() {
          MockInteractions.keyDownOn(target, 27);
        }

        function focusedDate() {
          return overlay.focusedDate;
        }

        function open(callback) {
          var listener = function() {
            datepicker.removeEventListener('iron-overlay-opened', listener);
            callback();
          };
          datepicker.addEventListener('iron-overlay-opened', listener);
          datepicker.open();
        }

        function getSelectionText() {
          var text = '';
          var activeEl = document.activeElement;
          var activeElTagName = activeEl ? activeEl.tagName.toLowerCase() : null;
          if (
            (activeElTagName == 'textarea' || activeElTagName == 'input') &&
            /^(?:text|search|password|tel|url)$/i.test(activeEl.type) &&
            (typeof activeEl.selectionStart == 'number')
          ) {
            text = activeEl.value.slice(activeEl.selectionStart, activeEl.selectionEnd);
          } else if (window.getSelection) {
            text = window.getSelection().toString();
          }
          return text;
        }

        beforeEach(function() {
          datepicker = fixture('datepicker');
          overlay = datepicker.$.overlay;
          target = datepicker.$.input;
        });

        it('should not clear selection on close (not focused)', function(done) {
          datepicker.addEventListener('iron-overlay-closed', function() {
            expect(target.selectionStart).not.to.equal(target.selectionEnd);
            done();
          });

          open(function() {
            arrowDown();
            // arrowDown();
            // datepicker.async(function() {
              // assert(target.selectionStart !== target.selectionEnd, 'Epic fail');
              target.blur();
              window.focus();
              datepicker.close();
            // }, 1);
          });
        });
      });
    }
  </script>

</body>

</html>
